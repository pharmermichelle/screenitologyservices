<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Set Password | ScreenITology</title>
    <meta name="robots" content="noindex,nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #0b0f16;
        color: #f6f8fb;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .card {
        background: #121826;
        border: 1px solid #1f2734;
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 360px;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #2a3443;
        background: #0e1420;
        color: #eaf1ff;
      }
      button {
        background: #1ed0f3;
        color: #041018;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .error {
        color: #ff6b81;
        font-size: 13px;
        margin-top: 8px;
      }
      .success {
        color: #1ed0f3;
        font-size: 13px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Set your password</h2>
      <p style="font-size: 14px; color: #a4b0be">
        Please choose a new password for your account.
      </p>

      <input type="password" id="password" placeholder="New password" />
      <input type="password" id="confirm" placeholder="Confirm password" />

      <button id="save">Update password</button>

      <div id="msg" class="error"></div>
    </div>

    <script>
      const SUPABASE_URL = "https://mltzrwltaheaunrdmyfb.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sdHpyd2x0YWhlYXVucmRteWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDk3MjgsImV4cCI6MjA4MDIyNTcyOH0.B7MvOu1wZ5LsRis5f7B-srJsaadOmN7FdV4PlNQvn2E";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const msg = document.getElementById("msg");

      document.getElementById("save").addEventListener("click", async () => {
        msg.textContent = "";

        const pw = document.getElementById("password").value;
        const confirm = document.getElementById("confirm").value;

        if (!pw || pw.length < 8) {
          msg.textContent = "Password must be at least 8 characters.";
          return;
        }

        if (pw !== confirm) {
          msg.textContent = "Passwords do not match.";
          return;
        }

        const { error } = await supabase.auth.updateUser({
          password: pw,
        });

        if (error) {
          msg.textContent = error.message;
          return;
        }

        // ðŸ”„ Ensure we have a fresh session
        await supabase.auth.refreshSession();

        msg.className = "success";
        msg.textContent = "Password updated. Redirectingâ€¦";

        setTimeout(() => {
          window.location.href = "/icecats-admin.html";
        }, 1200);
      });

      // Safety check: must be logged in
      (async () => {
        const { data } = await supabase.auth.getSession();
        if (!data.session) {
          msg.textContent =
            "This password reset link is invalid or expired. Please return to the login page and request a new reset email.";
        }
      })();
    </script>
  </body>
</html>
