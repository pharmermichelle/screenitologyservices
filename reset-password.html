<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Set Password | ScreenITology</title>
    <meta name="robots" content="noindex,nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #0b0f16;
        color: #f6f8fb;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .card {
        background: #121826;
        border: 1px solid #1f2734;
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 360px;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #2a3443;
        background: #0e1420;
        color: #eaf1ff;
      }
      button {
        background: #1ed0f3;
        color: #041018;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .error {
        color: #ff6b81;
        font-size: 13px;
        margin-top: 8px;
      }
      .success {
        color: #1ed0f3;
        font-size: 13px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <form id="reset-form">
        <input
          id="password"
          type="password"
          placeholder="New password"
          required
        />
        <input
          id="confirm-password"
          type="password"
          placeholder="Confirm password"
          required
        />
        <button type="submit">Update password</button>
        <p id="status"></p>
      </form>
    </div>

    <script>
      const SUPABASE_URL = "https://mltzrwltaheaunrdmyfb.supabase.co";
      const SUPABASE_ANON_KEY =
        "YeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sdHpyd2x0YWhlYXVucmRteWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDk3MjgsImV4cCI6MjA4MDIyNTcyOH0.B7MvOu1wZ5LsRis5f7B-srJsaadOmN7FdV4PlNQvn2E";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const form = document.getElementById("reset-form");
      const passwordInput = document.getElementById("password");
      const confirmInput = document.getElementById("confirm-password");
      const status = document.getElementById("status");
      const button = form.querySelector("button"); // ðŸ‘ˆ ADD THIS

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        button.disabled = true; // ðŸ‘ˆ DISABLE BUTTON ON SUBMIT

        const password = passwordInput.value;
        const confirm = confirmInput.value;

        if (password.length < 8) {
          status.textContent = "Password must be at least 8 characters.";
          status.className = "error";
          button.disabled = false; // ðŸ‘ˆ ADD
          return;
        }

        if (password !== confirm) {
          status.textContent = "Passwords do not match.";
          status.className = "error";
          button.disabled = false; // ðŸ‘ˆ ADD
          return;
        }

        status.textContent = "Updating passwordâ€¦";
        status.className = "";

        const { error } = await supabase.auth.updateUser({
          password,
        });

        if (error) {
          status.textContent = error.message;
          status.className = "error";
          button.disabled = false; // ðŸ‘ˆ RE-ENABLE ON ERROR
          return;
        }

        await supabase.auth.refreshSession();

        status.textContent = "Password updated successfully!";
        status.className = "success";

        setTimeout(() => {
          window.location.href = "/icecats-admin.html";
        }, 1200);
      });

      // Safety check: must be in a recovery session
      (async () => {
        const { data } = await supabase.auth.getSession();

        if (!data.session || data.session.user.recovery_sent_at === null) {
          status.textContent =
            "This password reset link is invalid or expired. Please request a new reset email.";
          status.className = "error";
          button.disabled = true; // ðŸ‘ˆ LOCK FORM
        }
      })();
    </script>
  </body>
</html>
